{% extends "base.html" %}

{% block title %}Kullanıcı Yönetimi{% endblock %}

{% block head %}
<style>
    .profile-img-small {
        width: 50px;
        height: 50px;
        border-radius: 50%;
    }

    .btn-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px; /* Butonlar arasındaki boşluğu 10px yap */
    }

    .btn-group .btn {
        flex: 1 1 auto;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
    }

    .action-buttons form {
        margin-bottom: 10px; /* Butonlar arasına 10px boşluk ekler */
    }

    .action-buttons form:last-child {
        margin-bottom: 0; /* Son formun altında boşluk olmamasını sağlar */
    }

    .btn-container {
        display: flex;
        flex-direction: column;
        gap: 10px; /* Buton grupları arasına 10px boşluk ekler */
    }

    .btn-group-row {
        display: flex;
        gap: 10px; /* Butonlar arasına 10px boşluk ekler */
        margin-bottom: 10px; /* Buton grupları arasına 10px boşluk ekler */
    }

    .btn-group-row form {
        flex: 1;
    }

    hr {
        border: 0;
        border-top: 1px solid #eee;
        margin: 10px 0;
    }

    .new-message-button {
        margin-bottom: 20px; /* Butonlar arasına 20px boşluk ekler */
    }

    .btn-group-row:last-child {
        margin-bottom: 0; /* Son buton grubunun altında boşluk olmamasını sağlar */
    }
</style>
<script>
    function confirmAction(event, message) {
        if (!confirm(message)) {
            event.preventDefault();
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('form').forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (form.action.includes('ban_user')) {
                    confirmAction(event, 'Bu kullanıcıyı banlamak istediğinize emin misiniz?');
                } else if (form.action.includes('delete_user_comments')) {
                    confirmAction(event, 'Bu kullanıcının tüm yorumlarını silmek istediğinize emin misiniz?');
                } else if (form.action.includes('toggle_admin')) {
                    confirmAction(event, 'Bu kullanıcıya yetki vermek/kaldırmak istediğinize emin misiniz?');
                } else if (form.action.includes('delete_user')) {
                    confirmAction(event, 'Bu hesabı silmek istediğinize emin misiniz?');
                }
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<main class="container mt-5">
    <h2>Kullanıcı Yönetimi</h2>
    <div class="new-message-button">
        <form action="{{ url_for('send_message') }}" method="get">
            <button type="submit" class="btn btn-sm btn-danger">Duyuru</button>
        </form>
    </div><br>
    <form method="GET" action="{{ url_for('admin_users') }}" class="search-form mb-3">
        <input type="text" name="search" class="form-control mb-2" placeholder="Kullanıcı ara..." value="{{ request.args.get('search', '') }}">
        <select class="form-control mb-2" name="filter">
            <option value="">Filtreleme Yap</option>
            <option value="banned">Banlı Olanlar</option>
            <option value="admin">Admin Olanlar</option>
        </select>
        <button type="submit" class="btn btn-primary">Ara ve Sırala</button>
    </form>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Profil Fotoğrafı</th>
                <th>Kullanıcı Adı</th>
                <th>Email</th>
                <th>Ban Durumu</th>
                <th>İşlemler</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>
                    {% if user.profile_image %}
                        <img src="{{ url_for('static', filename=user.profile_image) }}" alt="Profil Fotoğrafı" class="profile-img-small">
                    {% else %}
                        <img src="{{ url_for('static', filename='images/default_profile.png') }}" alt="Profil Fotoğrafı" class="profile-img-small">
                    {% endif %}
                </td>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td>{{ 'Banlı' if user.is_banned else 'Aktif' }}</td>
                <td>
                    <div class="btn-container">
                        <div class="btn-group-row">
                            <form action="{{ url_for('ban_user', user_id=user.id) }}" method="post">
                                <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('Bu kullanıcıyı banlamak istediğinize emin misiniz?')">{{ 'Banı Kaldır' if user.is_banned else 'Banla' }}</button>
                            </form>
                            <form action="{{ url_for('delete_user_comments', user_id=user.id) }}" method="post">
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Bu kullanıcının tüm yorumlarını silmek istediğinize emin misiniz?')">Yorumları Sil</button>
                            </form>
                            <form action="{{ url_for('toggle_admin', user_id=user.id) }}" method="post">
                                <button type="submit" class="btn btn-info btn-sm" onclick="return confirm('Bu kullanıcıya yetki vermek/kaldırmak istediğinize emin misiniz?')">{{ 'Yetkili Kullanıcı' if user.is_admin else 'Yetkisiz Kullanıcı' }}</button>
                            </form>
                        </div>
                        <div class="btn-group-row">
                            <form action="{{ url_for('delete_user', user_id=user.id) }}" method="post">
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Bu hesabı silmek istediğinize emin misiniz?')">Hesabı Sil</button>
                            </form>
                            <form action="{{ url_for('view_user_comments', user_id=user.id) }}" method="get">
                                <button type="submit" class="btn btn-secondary btn-sm">Yorumları Gör</button>
                            </form>
                            <form action="{{ url_for('message_user', user_id=user.id) }}" method="get">
                                <button type="submit" class="btn btn-primary btn-sm">Mesaj Gönder</button>
                            </form>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="5"><hr></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</main>
{% endblock %}
